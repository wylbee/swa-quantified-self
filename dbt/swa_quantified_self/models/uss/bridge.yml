version: 2
models:
  - name: bridge
    meta:
      joins:
        - join: ent_activity
          sql_on: ${bridge.key_activity} = ${ent_activity.key_activity}
        - join: ent_budget
          sql_on: ${bridge.key_budget} = ${ent_budget.key_budget}
        - join: ent_calendar
          sql_on: ${bridge.key_calendar} = ${ent_calendar.key_calendar}
        - join: ent_finaccount
          sql_on: ${bridge.key_finaccount} = ${ent_finaccount.key_finaccount}
      metrics:
        savings_rate:
          type: number
          sql: safe_divide(${amt_invested_sum},${amt_income_sum})
          format: percent
          round: 2
        performance_to_plan_income:
          type: number
          sql: safe_divide(${amt_income_sum},${amt_budget_income_sum})
          format: percent
          round: 2
        performance_to_plan_save:
          type: number
          sql: safe_divide(${amt_invested_sum},${amt_budget_save_sum})
          format: percent
          round: 2
        performance_to_plan_spend:
          type: number
          sql: safe_divide(${amt_expense_sum},${amt_budget_spend_sum})
          format: percent
          round: 2
        annualized_income_swr:
          type: number
          sql: ${amt_balance_investment_lv_dly} * .04
          format: usd
          round: 2
          group_label: fi
        annualized_income_twr:
          type: number
          sql: ${amt_balance_investment_lv_dly} * .035
          format: usd
          round: 2
          group_label: fi
        annualized_income_pwr:
          type: number
          sql: ${amt_balance_investment_lv_dly} * .0325
          format: usd
          round: 2
          group_label: fi
        amt_budget_retirement_expected_spend_give_annual:
          type: number
          format: usd
          group_label: fi
          sql: (${amt_budget_retirement_expected_spend_annual})/.9
        val_budget_retirement_expected_tax_rate:
          type: max
          format: percent
          group_label: fi
          sql: >-
            case when extract(year from ${key_calendar}) = 2022 then .215 when
            extract (year from ${key_calendar})=2023 then .21 end
        amt_budget_retirement_expected_spend_give_tax_annual:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_annual}/(1-${val_budget_retirement_expected_tax_rate})
        progress_to_twr:
          type: number
          format: percent
          round: 2
          group_label: fi
          sql: >-
            ${annualized_income_twr}/${amt_budget_retirement_expected_spend_give_tax_annual}
        amt_budget_coast_65:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(65-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_60:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(60-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_55:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(55-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_54:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(54-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_53:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(53-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_52:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(52-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_51:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(51-date_diff(current_date(),
            '1990-08-18', year))))
        amt_budget_coast_50:
          type: number
          format: usd
          group_label: fi
          sql: >-
            ${amt_budget_retirement_expected_spend_give_tax_annual}/(.035*pow((1+.072),(50-date_diff(current_date(),
            '1990-08-18', year))))
        progress_to_coast_milestone:
          type: number
          format: percent
          group_label: fi
          round: 2
          sql: safe_divide(${amt_balance_investment_lv_dly},${amt_budget_coast_53})
    columns:
      - name: _dbt_source_relation
        description: ""
        meta:
          dimension:
            type: string
            hidden: true
      - name: key_activity
        description: ""
        meta:
          dimension:
            type: string
      - name: key_self
        description: ""
        meta:
          dimension:
            type: string
      - name: key_finaccount
        description: ""
        meta:
          dimension:
            type: string
      - name: key_budget
        description: ""
        meta:
          dimension:
            type: string
      - name: key_calendar
        description: ""
        meta:
          dimension:
            type: date
      - name: cat_source
        description: ""
        meta:
          dimension:
            type: string
      - name: amt_activity_cash_flow_impact
        description: ""
        meta:
          dimension:
            type: number
      - name: amt_income
        description: ""
        meta:
          dimension:
            type: number
          metrics:
            amt_income_sum:
              type: sum
              round: 2
              format: usd
      - name: amt_invested
        description: ""
        meta:
          dimension:
            type: number
          metrics:
            amt_invested_sum:
              type: sum
              round: 2
              format: usd
      - name: amt_expense
        description: ""
        meta:
          dimension:
            type: number
          metrics:
            amt_expense_sum:
              type: sum
              round: 2
              format: usd
              sql: ${amt_expense}*-1
      - name: amt_budget
        description: ""
        meta:
          dimension:
            type: number
          metrics:
            amt_budget_sum:
              type: sum
              round: 2
              format: usd
            amt_budget_income_sum:
              type: sum
              round: 2
              format: usd
              filters:
                - ent_budget.is_budget_income: 1
            amt_budget_save_sum:
              type: sum
              round: 2
              format: usd
              filters:
                - ent_budget.is_budget_save: 1
            amt_budget_spend_sum:
              type: sum
              round: 2
              format: usd
              filters:
                - ent_budget.is_budget_spend: 1
            amt_budget_core_sum:
              type: sum
              round: 2
              format: usd
              filters:
                - ent_budget.is_budget_core: 1
            amt_budget_retirement_expected_spend_annual:
              type: sum
              sql: ${amt_budget}*12
              round: 2
              format: usd
              filters:
                - ent_budget.is_budget_core: 1
      - name: amt_balance
        description: ""
        meta:
          dimension:
            type: number
      - name: amt_balance_lv
        description: ""
        meta:
          dimension:
            type: number
          metrics:
            amt_balance_lv_dly:
              type: sum
              round: 2
              format: usd
            amt_balance_investment_lv_dly:
              type: sum
              round: 2
              format: usd
              filters:
                - ent_finaccount.is_finaccount_savings: 1
